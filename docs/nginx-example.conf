# PingCode MCP Server - Nginx 反向代理配置示例
#
# 使用场景：
# 1. 内网部署，通过 nginx 统一入口
# 2. 添加 HTTPS/SSL 终止
# 3. 基于 nginx 的认证（Basic Auth 或 auth_request）
# 4. 负载均衡多个 MCP 实例
#
# 安装位置：/etc/nginx/conf.d/pingcode-mcp.conf

upstream pingcode_mcp {
    # 单实例
    server 127.0.0.1:3000;

    # 多实例负载均衡（可选）
    # server 127.0.0.1:3001;
    # server 127.0.0.1:3002;

    # 保持长连接（SSE 需要）
    keepalive 32;
}

server {
    listen 80;
    listen [::]:80;
    server_name mcp.internal.example.com;

    # 强制 HTTPS（生产环境推荐）
    # return 301 https://$server_name$request_uri;

    # 以下配置也可放在 HTTPS server block 中

    # ========== 认证配置 ==========

    # 方式 1: Basic Auth（简单场景）
    # auth_basic "PingCode MCP";
    # auth_basic_user_file /etc/nginx/.htpasswd;

    # 方式 2: 外部认证服务（如 OAuth2 Proxy）
    # location = /auth {
    #     internal;
    #     proxy_pass http://oauth2-proxy:4180/oauth2/auth;
    #     proxy_pass_request_body off;
    #     proxy_set_header Content-Length "";
    #     proxy_set_header X-Original-URI $request_uri;
    # }

    # ========== 健康检查（不需要认证）==========

    location /health {
        proxy_pass http://pingcode_mcp;
        proxy_set_header Host $host;
    }

    # ========== 指标端点（内部监控用）==========

    location /metrics {
        # 限制只允许内网访问
        allow 10.0.0.0/8;
        allow 172.16.0.0/12;
        allow 192.168.0.0/16;
        allow 127.0.0.1;
        deny all;

        proxy_pass http://pingcode_mcp;
        proxy_set_header Host $host;
    }

    # ========== MCP 端点（需要认证）==========

    location /mcp {
        # 如果使用 auth_request
        # auth_request /auth;

        # 如果使用 Basic Auth，上面已全局配置

        # 代理配置
        proxy_pass http://pingcode_mcp;
        proxy_http_version 1.1;

        # 传递客户端真实 IP
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # SSE 支持（关闭缓冲）
        proxy_buffering off;
        proxy_cache off;

        # 长连接支持
        proxy_set_header Connection '';
        proxy_read_timeout 86400s;  # 24 小时
        proxy_send_timeout 86400s;

        # 传递 MCP Session ID
        proxy_set_header Mcp-Session-Id $http_mcp_session_id;

        # 传递 API Key（如果客户端提供）
        proxy_set_header Authorization $http_authorization;
        proxy_set_header X-API-Key $http_x_api_key;
    }

    # ========== 其他路径返回 404 ==========

    location / {
        return 404 '{"error": "Not found"}';
        add_header Content-Type application/json;
    }
}

# ========== HTTPS 配置（推荐）==========

# server {
#     listen 443 ssl http2;
#     listen [::]:443 ssl http2;
#     server_name mcp.internal.example.com;
#
#     ssl_certificate /etc/nginx/ssl/mcp.crt;
#     ssl_certificate_key /etc/nginx/ssl/mcp.key;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
#     ssl_prefer_server_ciphers off;
#
#     # 其他配置同上 HTTP server block
#     # ...
# }
